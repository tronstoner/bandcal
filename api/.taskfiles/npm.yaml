---
version: 3

vars:
  USER_ID:
    sh: id -u
  GROUP_ID:
    sh: id -g
  HOME:
    sh: echo $HOME

tasks:
  command:
    internal: true
    vars:
      COMMAND: '{{default "install" .COMMAND}}'
      VERSION:
        sh: cat {{.PROJECT_DIR}}/.nvmrc
    dir: "{{.PROJECT_DIR}}"
    cmds:
      - |-
        docker run --rm -i \
          -v $PWD:/app \
          -v /etc/group:/etc/group:ro \
          -v /etc/passwd:/etc/passwd:ro \
          -v /etc/shadow:/etc/shadow:ro \
          -v {{.HOME}}/.npm:/tmp/.npm \
          --workdir=/app \
          -e NPM_CONFIG_CACHE=/tmp/.npm \
          -e HOME=/tmp \
          --user root:root \
          --network=host \
          node:{{.VERSION}}-alpine \
            npm {{.COMMAND}}

  default:
    desc: Run a arbitrary npm command. Example `task npm -- help`
    summary: |
      Run an arbitrary npm command in a docker container. Example `task npm -- help`

      Used for installing packages, updating packages, ...
      Examples:
      * `task npm -- install <package name>`
      * `task npm -- update`
      * `task npm -- ls <package name>`
      * `task npm -- ci`
    cmds:
      - task: command
        vars: { COMMAND: "{{.CLI_ARGS}}" }

  dev:
    desc: Run the development server.
    vars:
      VERSION:
        sh: cat {{.PROJECT_DIR}}/.nvmrc
    dir: "{{.PROJECT_DIR}}"
    cmds:
      - |-
        docker run --rm -i \
          -v $PWD:/app \
          -v /etc/group:/etc/group:ro \
          -v /etc/passwd:/etc/passwd:ro \
          -v /etc/shadow:/etc/shadow:ro \
          -v {{.HOME}}/.npm:/tmp/.npm \
          --workdir=/app \
          -e HOME=/tmp \
          -p 3000:3000 \
          node:{{.VERSION}}-alpine \
            npm run dev -- --port 3000

  start:
    desc: Run the production server.
    vars:
      VERSION:
        sh: cat {{.PROJECT_DIR}}/.nvmrc
    dir: "{{.PROJECT_DIR}}"
    cmds:
      - |-
        docker run --rm -i \
          -v $PWD:/app \
          -v /etc/group:/etc/group:ro \
          -v /etc/passwd:/etc/passwd:ro \
          -v /etc/shadow:/etc/shadow:ro \
          -v {{.HOME}}/.npm:/tmp/.npm \
          --workdir=/app \
          -e HOME=/tmp \
          -p 3000:3000 \
          node:{{.VERSION}}-alpine \
            npm start -- --port 3000

  ci:
    desc: Install all dependencies defined for npm.
    interactive: true
    cmds:
      - task: command
        vars: { COMMAND: "ci" }

  build:
    desc: Build the production bundle.
    interactive: true
    cmds:
      - task: command
        vars: { COMMAND: "run build" }

  lint:
    desc: Run lint on the code base.
    interactive: true
    cmds:
      - task: command
        vars: { COMMAND: "run lint" }

  lint:fix:
    desc: Run lint on the code base and automatically fix errors.
    interactive: true
    cmds:
      - task: command
        vars: { COMMAND: "run lint:fix" }

  test:
    desc: Run all tests.
    interactive: true
    cmds:
      - task: command
        vars: { COMMAND: "run test" }
